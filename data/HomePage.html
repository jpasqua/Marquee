<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src='//openweathermap.org/themes/openweathermap/assets/vendor/owm/js/d3.min.js'></script>

<style>
  .aligned { display: flex; align-items: center; }
  .aligned > img { margin-right: 10px; }
</style>

<div id="PRINTER_AREA" class='w3-row' style='display:none'>
  <h2>Printer Status</h2>
</div>

<div class='w3-row'>
  <h2>Forecast</h2>
</div>
<div id="openweathermap-widget-11" class='w3-margin-bottom'></div>

<div id="NEWS_AREA" class='w3-cell-row' style='display:none'>
  <h2 id="NewsHeading"></h2>
</div>

<script>
  function fillPrinterFields(printerInfo, onElement) {
    console.log(printerInfo.pct, printerInfo.pct == 100);
    if (printerInfo.hasOwnProperty("pct") && printerInfo.pct == 100) {
      printerInfo.completeAt = "[complete]";
    }
    $(onElement).append("<div class='w3-border'></div>");
    let theContainer = $(onElement).children().last();
    theContainer.append(
      "<div class='w3-cell w3-container'>" +
      "  <a href='" + printerInfo.url + "'>" + printerInfo.name + "</a>" +
      "</div>");
    if (printerInfo.hasOwnProperty("pct")) {
      $(theContainer).append(
          "<div class='w3-cell w3-container'>" + printerInfo.pct + "\%"+ "</div>" +
          "<div class='w3-cell w3-container'>" +
          "  Time Remaining: " + Math.floor(printerInfo.remaining/60) + "H:" + printerInfo.remaining\%60 + "M" + 
          "</div> <div class='w3-cell w3-container'>" +
          "   Complete At: " + printerInfo.completeAt +
          "</div> <div class='w3-row w3-container'>" + printerInfo.file + "</div>");
    }
  }

  function fillNews(articles) {
    let onElement = $("#NEWS_AREA");
    articles.forEach(article => {
      onElement.append(
        "<div class='w3-row w3-margin-bottom aligned'>" +
        "  <img src='" + article.urlToImage + "' style='float:left; border: solid 1px;' height='90'/>" +
        "  <div>" +
        "    <div><a href='" + article.url + "'>" + article.title + "</a></div>" +
        "    <div>" + article.description + "</div>" +
        "  </div>" +
        "</div>");
    });
  }

  function loadNews(theSettings) {
    var xmlhttp = new XMLHttpRequest();
  
    xmlhttp.open(
      'GET',
      'http://marquee.local/pass?srcURL=http://newsapi.org/v2/top-headlines?' +
        'sources=' + theSettings.source +
        '\%26apiKey=' + theSettings.apiKey +
        '\%26type=json');
    xmlhttp.onreadystatechange=function(){
      if(xmlhttp.readyState==4){
        if(xmlhttp.status==200){
          allNews = JSON.parse(xmlhttp.responseText);
          fillNews(allNews.articles);
        }
      }
    };
    xmlhttp.send();
    $("#NewsHeading").html("Headlines from " + theSettings.source);
  }

  function loadWeatherWidget() {
    window.myWidgetParam ? window.myWidgetParam : window.myWidgetParam = [];
    window.myWidgetParam.push({ id: 11, cityid: '%CITYID%', appid: '%WEATHER_KEY%', units: '%UNITS%', containerid: 'openweathermap-widget-11', });
    (function() {
      var script = document.createElement('script');
      script.async = true;
      script.charset = "utf-8";
      script.src = "//openweathermap.org/themes/openweathermap/assets/vendor/owm/js/weather-widget-generator.js";
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(script, s); })();
  }

  var printersEnabled = %PM_ENABLED%;
  var newsSettings = %NS_SETTINGS%;

  if (printersEnabled) {
    let printerInfo = JSON.parse('%PRINTER_INFO%');
    printerInfo = printerInfo.sort((p1, p2) => 
      (p2.remaining < p1.remaining) ? 1 : (p2.remaining > p1.remaining) ? -1 : 0);
    var firstPrinterAdded = true;
    printerInfo.forEach(function(cur) {
      if (!firstPrinterAdded) {
         $("#PRINTER_AREA").append("<div style='margin-bottom:10px;'></div>");
      }
      fillPrinterFields(cur, "#PRINTER_AREA");
      firstPrinterAdded = false;
    });
    $("#PRINTER_AREA").css("display", "block");
  }

  if (newsSettings.enabled) {
    $("#NEWS_AREA").css("display", "block");
    loadNews(newsSettings);
  }

  loadWeatherWidget();

</script>
