<script>
  function showHide(elementID, show) {
    var x = document.getElementById(elementID);
    if (show) { x.style.display = 'block'; } else { x.style.display = 'none'; }
  }
  function isNumberKey(e) { var h = e.which ? e.which : event.keyCode; return !(h > 31 && (h < 48 || h > 57)) }
</script>

<form class='w3-container' action='/updateMQConfig' method='get'>
  <h2>Marquee Settings:</h2>

<p><label>Display home screen for (seconds):</label><input class='w3-input w3-border w3-margin-bottom' type='text' name='homeScreenTime' value='%HS_TIME%' maxlength='5' onkeypress='return isNumberKey(event)'></p>
  <p><label>Frame Delay (ms):</label><input class='w3-input w3-border w3-margin-bottom' type='text' name='scrollDelay' value='%SCROLL_DELAY%' maxlength='10'></p>


  <b>Adafruit IO</b><br>
  <div class='w3-card-2 w3-round-large'>
    <div class='w3-container w3-margin-bottom'>
        <div class='w3-row'>
          <p><label>Username</label><input class='w3-input w3-border w3-margin-bottom' type='text' name='aioUsername' value='%AIO_USER%' maxlength='60'></p>
          <p><label>Key</label><input class='w3-input w3-border w3-margin-bottom' type='text' name='aioKey' value='%AIO_KEY%' maxlength='60'></p>
          <p><label>Group</label><input class='w3-input w3-border w3-margin-bottom' type='text' name='aioGroup' value='%AIO_GROUP%' maxlength='60'></p>
        </div>
    </div>
  </div>

  <button class='w3-button w3-block w3-round-large w3-grey w3-section w3-padding' type='submit'>Save</button>
</form>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://raw.githack.com/SortableJS/Sortable/master/Sortable.js"></script>
<style type="text/css">
  .sortItem { border-style: solid; margin:1px; padding:4px; float: left; }
  .ghost {
      color: #fff;
      background-color: #00C;
      position: relative;
      opacity: 0.4;
  }
</style>

<div class="w3-card-2 w3-round-large w3-margin">
  <div class="w3-container w3-margin-bottom">
    <b>Weather Screen Fields</b>
    <div class='w3-row w3-padding'>
      Select the fields you'd like to see and drag them into your preferred order
      <div id="weatherFields" class="w3-margin-bottom">
      </div>
      <div class="w3-row w3-padding"></div>
      <div class="w3-row">
        <input type="button" value='Save' onclick="createResultList('#weatherFields', '/updateWeatherFields')">
        &nbsp;<span id='RESULT' class='w3-margin-left' style='font-style: italic;'></span>
      </div>
    </div>
  </div>
</div>
  
<script type="text/javascript">
  function showResult(status, data) {
    $('#RESULT').attr('style', 'color:' + (status ? 'green' : 'red'));
    $('#RESULT').html((status ? 'Success' : 'Error') + ': ' + data);
    setTimeout(function() {
      $("#RESULT").fadeOut("slow", function() {
        $('#RESULT').html('');
        $('#RESULT').attr("style","display:block");
      }
    );
    } ,3000);
  }
  function createResultList(fromFields, saveAction) {
    var resultList = { fields: [] };
    $( fromFields ).children().each( function( index, element ) {
      var item = element.getElementsByClassName('order')[0];
      resultList.fields.push({id: item.name, on: item.checked});
    });
    console.log(resultList);
    $('#RESULT').attr('style', 'color: #808080');
    $('#RESULT').html("Updating weather fields...");
    $.ajax({
        // url: 'https://httpbin.org/get',
        url: saveAction,
        type: 'post',
        dataType: 'text',
        contentType: 'application/json',
        success: function(data) { showResult(true, data) },
        error: function(data) { showResult(false, data) },
        data: JSON.stringify(resultList)
    });
  }
  function createList(fields, onElement) {
    for(var i = 0; i < fields.length; i++) {
        var field = fields[i];
        $(onElement).append(
          "<div class='sortItem w3-theme-light'>" +
          "  <input class='order' type='checkbox' name='" + field.id + "' " +
             (field.on ? "checked>" : ">") +
          "  <label for='" + field.id + "'>&nbsp;" + field.id + "</label>" +
          "</div>"
          );
      }
  }
  var weatherSequence = JSON.parse(`%WS_FIELDS%`);

  createList(weatherSequence.fields, '#weatherFields');
  new Sortable(weatherFields, { animation: 150, ghostClass: 'ghost' });
</script>