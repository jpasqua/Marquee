<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://raw.githack.com/SortableJS/Sortable/master/Sortable.js"></script>
<script>
  function showHide(elementID, show) {
    var x = document.getElementById(elementID);
    if (show) { x.style.display = 'block'; } else { x.style.display = 'none'; }
  }
  function isNumberKey(e) { var h = e.which ? e.which : event.keyCode; return !(h > 31 && (h < 48 || h > 57)) }
</script>

<form class='w3-container' action='/updateMQConfig' method='get'>
  <b>General Settings</b><br>
  <div class='w3-card-2 w3-round-large'>
    <div class='w3-container w3-margin-bottom'>
      <p><label>Display home screen for (seconds):</label><input class='w3-input w3-border w3-margin-bottom' type='text' name='homeScreenTime' value='%HS_TIME%' maxlength='5' onkeypress='return isNumberKey(event)'></p>
      <p><label>Frame Delay (ms):</label><input class='w3-input w3-border w3-margin-bottom' type='text' name='scrollDelay' value='%SCROLL_DELAY%' maxlength='10'></p>
    </div>
  </div>

  <b>Adafruit IO</b><br>
  <div class='w3-card-2 w3-round-large'>
    <div class='w3-container w3-margin-bottom'>
        <div class='w3-row'>
          <p><label>Username</label><input class='w3-input w3-border w3-margin-bottom' type='text' name='aioUsername' value='%AIO_USER%' maxlength='60'></p>
          <p><label>Key</label><input class='w3-input w3-border w3-margin-bottom' type='text' name='aioKey' value='%AIO_KEY%' maxlength='60'></p>
          <p><label>Group</label><input class='w3-input w3-border w3-margin-bottom' type='text' name='aioGroup' value='%AIO_GROUP%' maxlength='60'></p>
        </div>
    </div>
  </div>

<style type="text/css">
  .sortItem { border-style: solid; border-width: 1px; margin:1px; padding:4px; float: left; }
  .ghost {
      color: #fff;
      background-color: #00C;
      position: relative;
      opacity: 0.4;
  }
</style>

<b>Weather Screen Fields</b><br>
<div class="w3-card-2 w3-round-large">
  <div class="w3-container w3-margin-bottom w3-padding">
      Select the fields you'd like to see and drag them into your preferred order
      <div id="weatherFields" class="w3-margin-bottom">
      </div>
      <div class="w3-row w3-padding"></div>
      <div class="w3-row">
        <input type="button" value='Save' onclick="handleWeatherSave()">
        &nbsp;<span id='WSResultArea' class='w3-margin-left' style='font-style: italic;'></span>
      </div>
    </div>
  </div>

<b>Forecast Screen Fields</b><br>
<div class="w3-card-2 w3-round-large">
  <div class="w3-container w3-margin-bottom w3-padding">
      Select/Arrange the heading, and the fields for each day
      <div style="flex">
        <div style="border: solid 1px; float: left; padding: 2px; margin-right:10px">
          <div id="fcstHeadFields" class="w3-margin-bottom"></div>
        </div>
        <div style="border: solid 1px; float: left; padding: 2px">
         <div id="fcstFields" class="w3-margin-bottom"></div>
        </div>
      </div>

      <div class="w3-row">
        <label>Label:&nbsp;</label>
        <input class='w3-input w3-border w3-margin-bottom' type='text' id='fcstLabel' name='fcstLabel' value='100' maxlength='60'>
      </div>

      <div class="w3-row">
        <input type="button" value='Save' onclick="handleForecastSave();" >
        &nbsp;<span id='FSResultArea' class='w3-margin-left' style='font-style: italic;'></span>
      </div>
    </div>
  </div>

<script>
  function showResult(status, data, resultArea) {
    $(resultArea).attr('style', 'color:' + (status ? 'green' : 'red'));
    $(resultArea).html((status ? 'Success' : 'Error') + ': ' + data);
    setTimeout(function() {
      $(resultArea).fadeOut("slow", function() {
        $(resultArea).html('');
        $(resultArea).attr("style","display:block");
      }
    );
    } ,3000);
  }

  function getList(fromElement) {
    var resultList = [];
    $( fromElement ).children().each( function( index, element ) {
      var item = element.getElementsByClassName('order')[0];
      resultList.push({id: item.name, on: item.checked});
    });
    return resultList;
  }

  function doSubmit(payload, saveAction, resultArea) {
    $(resultArea).attr('style', 'color: #808080');
    $(resultArea).html("Updating weather fields...");
    $.ajax({
        // url: 'https://httpbin.org/get',
        url: saveAction,
        type: 'post',
        dataType: 'text',
        contentType: 'application/json',
        success: function(data) { showResult(true, data, resultArea) },
        error: function(data) { showResult(false, data, resultArea) },
        data: JSON.stringify(payload)
    });

  }

  function handleWeatherSave() {
    var theSettings = { fields: getList('#weatherFields') };
    doSubmit(theSettings, "/updateWSSettings", "#WSResultArea");
    console.log(resultList);
  }

  function handleForecastSave() {
    var theSettings = {
      heading: getList('#fcstHeadFields'),
      fields: getList('#fcstFields'),
      label: $('#fcstLabel').val()
    };
    console.log(theSettings);
    doSubmit(theSettings, "/updateFSSettings", "#FSResultArea");
  }

  function createList(fields, onElement) {
    for(var i = 0; i < fields.length; i++) {
        var field = fields[i];
        $(onElement).append(
          "<div class='sortItem w3-theme-light'>" +
          "  <input class='order' type='checkbox' name='" + field.id + "' " +
             (field.on ? "checked>" : ">") +
          "  <label for='" + field.id + "'>&nbsp;" + field.id + "</label>" +
          "</div>"
          );
      }
  }
  var weatherSequence = JSON.parse('%WS_SETTINGS%');
  createList(weatherSequence.fields, '#weatherFields');
  new Sortable(weatherFields, { animation: 150, ghostClass: 'ghost' });

  var fcstSettings = JSON.parse('%FS_SETTINGS%');

  createList(fcstSettings.heading, '#fcstHeadFields');
  new Sortable(fcstHeadFields, { animation: 150, ghostClass: 'ghost' });

  createList(fcstSettings.fields, '#fcstFields');
  new Sortable(fcstFields, { animation: 150, ghostClass: 'ghost' });
  $('#fcstLabel').val(fcstSettings.label);
</script>